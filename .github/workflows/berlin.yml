name: Create GitHub Pages

on:
  workflow_dispatch:
  schedule:
    - cron: '0 8 * * *'

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - uses: actions/checkout@v3

    - name: Checkout gh-pages branch
      uses: actions/checkout@v3
      with:
        ref: gh-pages
        path: osm-survey-jobs-gh-pages

    - name: Checkout bbbike repository
      uses: actions/checkout@v3
      with:
        repository: eserte/bbbike
        path: src/bbbike

    - name: Create osm-survey-jobs-berlin.bbbgeojsonp
      run: |
        set -ex
        wget 'https://api.openstreetmap.org/api/0.6/notes.json?bbox=13.051179,52.337621,13.764158,52.689878&limit=10000&closed=0' -O /tmp/notes-berlin.json
        ./find-osm-survey-jobs.pl /tmp/notes-berlin.json > /tmp/osm-survey-jobs-berlin.bbd
        PERL5LIB=$(pwd)/lib $GITHUB_WORKSPACE/src/bbbike/miscsrc/bbd2geojson -bbbgeojsonp -manipulatemodule GeoJSONFeatProps /tmp/osm-survey-jobs-berlin.bbd > $GITHUB_WORKSPACE/osm-survey-jobs-gh-pages/osm-survey-jobs-berlin.bbbgeojsonp

    - name: Prepare changes to gh-pages
      run: |
        set -ex
        cd $GITHUB_WORKSPACE/osm-survey-jobs-gh-pages
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        git add osm-survey-jobs-berlin.bbbgeojsonp
        git commit -m "automatic osm-survey-jobs-berlin.bbbgeojsonp update" && \
          git push origin gh-pages || true
